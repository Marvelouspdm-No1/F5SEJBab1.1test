<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <title>F5 SEJ BAB 1.1 Quiz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f2f2f2;
            max-width: 800px;
            margin: 0 auto;
        }
        .question {
            background: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .result {
            background: #e6ffe6;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .history {
            background: #e6f3ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .hidden {
            display: none;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #ddd;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
        }
        .save-buttons {
            margin-top: 20px;
            text-align: center;
        }
        .save-btn {
            background-color: #2196F3;
            margin: 5px;
        }
        .save-btn:hover {
            background-color: #0b7dda;
        }
        .download-btn {
            background-color: #FF6B35;
            margin: 5px;
        }
        .download-btn:hover {
            background-color: #E55A2B;
        }
        #reportCanvas {
            text-align: center;
        }
        .canvas-container {
            display: inline-block;
            margin: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
            padding: 15px 12px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            background-color: #fff;
            transition: all 0.3s ease;
            font-size: 16px;
            line-height: 1.4;
            min-height: 50px;
            display: flex;
            align-items: center;
        }
        label:hover {
            background-color: #f5f5f5;
            border-color: #2196F3;
        }
        label:active {
            background-color: #e3f2fd;
        }
        input[type="radio"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }
        input[type="radio"]:checked + span {
            font-weight: bold;
            color: #2196F3;
        }
        label.selected {
            background-color: #e3f2fd;
            border-color: #2196F3;
            font-weight: bold;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 16px;
            }
            .question {
                padding: 20px 15px;
                margin-bottom: 15px;
            }
            label {
                padding: 18px 15px;
                font-size: 17px;
                min-height: 60px;
            }
            input[type="radio"] {
                width: 22px;
                height: 22px;
                margin-right: 15px;
            }
            button {
                padding: 15px 25px;
                font-size: 17px;
                margin: 8px 5px;
                width: 100%;
                max-width: 300px;
            }
            h2 {
                font-size: 20px;
                line-height: 1.3;
            }
            .info-box {
                padding: 15px 12px;
                font-size: 15px;
            }
            .tab {
                padding: 12px 15px;
                font-size: 16px;
            }
        }
        .info-box {
            background: #e6f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>

<h2>F5 SEJ BAB 1.1 Quiz - Kedaulatan Negara</h2>
<div class="info-box">
    <p><strong>💡 温馨提示：</strong></p>
    <p>• 🖼️ <strong>生成成绩单图片</strong> - 制作正式的成绩单图片，可保存和分享</p>
    <p>• 💾 <strong>保存进度功能</strong> - 可以随时保存测验进度，稍后继续作答</p>
    <p>• 📚 本测验涵盖Bab 1.1国家主权(Kedaulatan Negara)的重要知识点</p>
    <p>• 📱 手机端已优化，选项按钮更大更容易点击</p>
</div>

<div class="tabs">
    <div class="tab active" onclick="showTab('quiz')">做测验</div>
    <div class="tab" onclick="showTab('history')">查看记录</div>
</div>

<div id="quiz" class="tab-content active">
    <form id="quizForm">
        <label>Name (名字):</label><br>
        <input type="text" id="name" required><br><br>

        <label>Form (年级):</label><br>
        <select id="form" required>
            <option value="">Select</option>
            <option value="F1">F1</option>
            <option value="F2">F2</option>
            <option value="F3">F3</option>
            <option value="F4">F4</option>
            <option value="F5">F5</option>
        </select><br><br>

        <div id="questions"></div>

        <button type="button" onclick="submitQuiz()">提交答案</button>
        <button type="button" onclick="saveProgress()">保存进度</button>
        <button type="button" onclick="loadProgress()">加载进度</button>
    </form>

    <div id="result" class="result hidden"></div>
</div>

<div id="history" class="tab-content">
    <h3>你的测验记录</h3>
    <div id="historyList"></div>
</div>

<script>
const questions = [
    {
        q: "Deklarasi Hubungan Persahabatan PBB telah diperkenalkan pada tahun 1970. Apakah kepentingan deklarasi tersebut?",
        options: [
            "Menekankan prinsip persamaan kedaulatan",
            "Mewujudkan pakatan ketenteraan",
            "Menghapuskan amalan kuasa veto",
            "Menamatkan persaingan senjata nuclear"
        ],
        answer: "Menekankan prinsip persamaan kedaulatan",
        explain: "Deklarasi Hubungan Persahabatan PBB 1970 mengesahkan prinsip persamaan kedaulatan dari segi undang-undang antarabangsa, yang penting untuk mengiktiraf kedudukan sama rata semua negara berdaulat.",
        encourage: "很好！你掌握了国际法中主权平等原则的重要性。"
    },
    {
        q: "Maklumat berikut berkaitan dengan peristiwa bersejarah di negara kita: Kemerdekaan Tanah Melayu 31 Ogos 1957 dan Pembentukan Malaysia 16 September 1963. Peristiwa di atas berkaitan dengan:",
        options: ["Perlembagaan", "Pentadbiran", "Kedaulatan", "Demokrasi"],
        answer: "Kedaulatan",
        explain: "Kemerdekaan Tanah Melayu 1957 dan pembentukan Malaysia 1963 mengukuhkan serta memantapkan negara bangsa kita yang bebas dan berdaulat.",
        encourage: "出色！你理解了这些历史事件与国家主权的关系。"
    },
    {
        q: "Berikut adalah perkataan Bahasa Yunani berkaitan kedaulatan: Supernuus dan Superanus. Perkataan tersebut merujuk negara yang:",
        options: ["Beraja", "Merdeka", "Autokrasi", "Demokrasi"],
        answer: "Merdeka",
        explain: "Dalam Bahasa Yunani, supernuus atau superanus bermaksud agung atau tertinggi, merujuk kepada negara yang bebas dan merdeka.",
        encourage: "正确！你掌握了主权概念的词源学知识。"
    },
    {
        q: "Mengapakah rakyat Malaysia perlu menghargai tokoh nasionalis negara?",
        options: [
            "Memupuk semangat patriotisme",
            "Menyusun semula masyarakat",
            "Mendapat pengiktirafan",
            "Memelihara maruah"
        ],
        answer: "Memupuk semangat patriotisme",
        explain: "Menghargai tokoh nasionalis negara dapat memupuk semangat patriotisme dan cinta akan negara dalam kalangan rakyat Malaysia.",
        encourage: "太棒了！你明白了尊重民族主义人物的重要意义。"
    },
    {
        q: "Rajah berikut merujuk jenis kedaulatan dalam masyarakat Melayu: Raja mempunyai kuasa tertinggi; Kedudukan raja diperkukuh oleh taat setia rakyat. X ialah kedaulatan:",
        options: ["Moden", "Tradisional", "Antarabangsa", "Undang-undang"],
        answer: "Tradisional",
        explain: "Kedaulatan Tradisional dalam sistem pemerintahan berkuasa mutlak pada kekuasaan dan kewibawaan raja, dengan kedudukan raja diperkukuhkan oleh taat setia rakyat.",
        encourage: "非常好！你能区分传统主权与现代主权的特征。"
    },
    {
        q: "Apakah langkah yang dilakukan untuk memelihara dan melaksanakan kedaulatan undang-undang di negara kita?",
        options: [
            "Mewujudkan badan kehakiman",
            "Membuat pindaan perlembagaan",
            "Melaksanakan undang-undang moden",
            "Menubuhkan Suruhanjaya Kehakiman"
        ],
        answer: "Mewujudkan badan kehakiman",
        explain: "Badan kehakiman diwujudkan untuk memelihara dan melaksanakan kedaulatan undang-undang, menjamin keadilan dalam kehidupan bermasyarakat.",
        encourage: "优秀！你理解了司法机构在维护法律主权中的作用。"
    },
    {
        q: "Pernyataan yang manakah berkaitan dengan kedaulatan tradisional? I. Diperkukuh kesetiaan rakyat II. Persamaan rumpun bangsa III. Prinsip keadilan ditegakkan IV. Pemerintah berkuasa mutlak",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "I dan IV",
        explain: "Kedaulatan Tradisional dicirikan dengan pemerintah berkuasa mutlak dan kedudukan raja diperkukuhkan oleh taat setia rakyat.",
        encourage: "很好！你能准确识别传统主权的核心特征。"
    },
    {
        q: "Penyataan berikut merupakan tafsiran berkaitan kedaulatan: 'Kedaulatan dibina berdasarkan prinsip kebebasan dan keadilan yang sentiasa memperjuangkan kebajikan dan kesejahteraan rakyat.' Siapakah tokoh yang telah membuat tafsiran tersebut?",
        options: [
            "Ibn Khaldun",
            "Tun Dr. Salleh Abas",
            "Dr. Ismail Abdul Rahman",
            "Tunku Abdul Rahman Putra al-Haj"
        ],
        answer: "Tunku Abdul Rahman Putra al-Haj",
        explain: "Tunku Abdul Rahman Putra al-Haj (Perdana Menteri Malaysia Pertama) mentafsirkan kedaulatan berdasarkan prinsip kebebasan, kebajikan dan keadilan.",
        encourage: "出色！你熟悉马来西亚开国领袖对主权的诠释。"
    },
    {
        q: "Mengapakah kedaulatan penting bagi sesebuah negara?",
        options: [
            "Mewujudkan kesejahteraan rakyat",
            "Menjadi kuasa politik unggul di dunia",
            "Menunjukkan kekuatan angkatan tentera",
            "Membuktikan dasar luar mengikut situasi semasa"
        ],
        answer: "Mewujudkan kesejahteraan rakyat",
        explain: "Kedaulatan penting untuk mewujudkan kesejahteraan rakyat melalui keberkesanan pentadbiran, kemakmuran ekonomi dan kestabilan politik.",
        encourage: "正确！你理解了主权对人民福祉的重要性。"
    },
    {
        q: "Apakah kepentingan konsep Daulat dalam sistem politik Melayu tradisional? I. Memperkukuh kedudukan raja-raja II. Memperluas peranan golongan pembesar III. Menyekat peluasan pengaruh kuasa asing IV. Mengikat kesetiaan rakyat terhadap raja",
        options: ["I dan II", "I dan IV", "II dan III", "III dan IV"],
        answer: "I dan IV",
        explain: "Konsep Daulat dalam sistem politik Melayu tradisional penting untuk memperkukuh kedudukan raja-raja dan mengikat kesetiaan rakyat terhadap raja.",
        encourage: "非常好！你掌握了马来传统政治中Daulat概念的意义。"
    }
];

function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.getElementById(tabId).classList.add('active');
    
    event.currentTarget.classList.add('active');
    
    if (tabId === 'history') {
        loadHistory();
    }
}

function submitQuiz() {
    const name = document.getElementById('name').value;
    const form = document.getElementById('form').value;
    
    if (!name || !form) {
        alert("请填写完整的个人信息！");
        return;
    }
    
    let score = 0;
    let results = [];
    let unanswered = 0;
    
    questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        const isCorrect = selected && selected.value === q.answer;
        
        if (isCorrect) score++;
        if (!selected) unanswered++;
        
        results.push({
            question: q.q,
            selected: selected ? selected.value : "未作答",
            correct: q.answer,
            isCorrect: isCorrect,
            explain: q.explain,
            encourage: q.encourage
        });
    });
    
    saveAttempt(name, form, score, results);
    displayResults(name, form, score, results, unanswered);
}

function displayResults(name, form, score, results, unanswered) {
    let output = `
        <h3>名字: ${name}</h3>
        <h3>年级: ${form}</h3>
        <h3>得分: <span class="${score >= 8 ? 'correct' : 'incorrect'}">${score} / 10</span></h3>
        ${unanswered > 0 ? `<p>注意：你有 ${unanswered} 题没有作答</p>` : ''}
        <p>${getFeedback(score)}</p>
        <div class="save-buttons">
            <button class="download-btn" onclick="generateReportImage('${name}', '${form}', ${score}, ${unanswered})">🖼️ 生成成绩单图片</button>
        </div>
        <div id="reportCanvas" style="margin-top: 20px;"></div>
        <hr>
    `;
    
    results.forEach((r, index) => {
        output += `
            <div class="question">
                <p><strong>第${index + 1}题：${r.isCorrect ? '正确 ✅' : '错误 ❌'}</strong></p>
                <p>题目: ${r.question}</p>
                ${!r.isCorrect ? `<p>你的答案: <span class="incorrect">${r.selected}</span></p>` : ''}
                <p>正确答案: <span class="correct">${r.correct}</span></p>
                <p>解释: ${r.explain}</p>
                <p>鼓励: ${r.encourage}</p>
            </div>
        `;
    });
    
    document.getElementById('result').innerHTML = output;
    document.getElementById('result').classList.remove('hidden');
    document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
}

function getFeedback(score) {
    if (score === 10) {
        return "太厉害啦！全对耶！你对国家主权的掌握非常完美！🎉 历史学霸就是你！";
    } else if (score >= 9) {
        return "成绩优异！你对国家主权的理解很深入，只有少许细节需要注意！✨ 继续保持！";
    } else if (score >= 7) {
        return "很不错！基本概念都掌握了，对历史发展脉络理解得很好！😊 加油！";
    } else if (score >= 5) {
        return "有进步空间！建议多复习主权的定义、类型和重要性，你会更棒的！💪";
    } else if (score >= 3) {
        return "需要加强复习哦！重点关注主权的概念和马来西亚主权的发展！📚";
    } else {
        return "建议重新学习这个章节，多看课本和笔记，历史需要慢慢积累的！🌱 不要放弃！";
    }
}

function formatDate(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

function generateReportImage(name, form, score, unanswered) {
    let wrongAnswers = [];
    questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        const isCorrect = selected && selected.value === q.answer;
        if (!isCorrect) {
            wrongAnswers.push({
                number: index + 1,
                question: q.q.substring(0, 50) + "...",
                selected: selected ? selected.value : "未作答",
                correct: q.answer
            });
        }
    });

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    const baseHeight = 800;
    const errorHeight = wrongAnswers.length * 30 + 100;
    canvas.width = 800;
    canvas.height = Math.max(baseHeight, baseHeight + errorHeight);
    
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#f8f9fa');
    gradient.addColorStop(1, '#e9ecef');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = '#2c3e50';
    ctx.fillRect(0, 0, canvas.width, 120);
    
    ctx.fillStyle = 'white';
    ctx.font = 'bold 28px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('F5 SEJ BAB 1.1 Quiz', canvas.width/2, 45);
    ctx.font = 'bold 24px Arial';
    ctx.fillText('Kedaulatan Negara', canvas.width/2, 75);
    ctx.font = '18px Arial';
    ctx.fillText('国家主权测验成绩单', canvas.width/2, 100);
    
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('学生信息 Student Information', 50, 170);
    
    ctx.font = '20px Arial';
    ctx.fillText(`姓名 Name: ${name}`, 50, 210);
    ctx.fillText(`年级 Form: ${form}`, 50, 240);
    ctx.fillText(`测验日期 Date: ${formatDate(new Date())}`, 50, 270);
    
    const percentage = Math.round((score / 10) * 100);
    
    ctx.fillStyle = '#2196F3';
    ctx.font = 'bold 24px Arial';
    ctx.fillText('测验成绩 Test Results', 50, 320);
    
    const centerX = canvas.width - 150;
    const centerY = 370;
    const radius = 80;
    
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fillStyle = score >= 8 ? '#4CAF50' : score >= 5 ? '#FF9800' : '#F44336';
    ctx.fill();
    
    ctx.fillStyle = 'white';
    ctx.font = 'bold 36px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${score}/10`, centerX, centerY - 10);
    ctx.font = 'bold 20px Arial';
    ctx.fillText(`${percentage}%`, centerX, centerY + 20);
    
    ctx.fillStyle = '#333';
    ctx.font = '20px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`总分 Total Score: ${score}/10 (${percentage}%)`, 50, 360);
    
    if (unanswered > 0) {
        ctx.fillStyle = '#F44336';
        ctx.fillText(`未作答题目 Unanswered: ${unanswered} 题`, 50, 390);
    }
    
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    let currentY = unanswered > 0 ? 450 : 420;
    ctx.fillText('表现分析 Performance Analysis', 50, currentY);
    
    ctx.font = '18px Arial';
    const feedback = getFeedback(score);
    const words = feedback.split(' ');
    let line = '';
    currentY += 30;
    
    for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        if (testWidth > 700 && n > 0) {
            ctx.fillText(line, 50, currentY);
            line = words[n] + ' ';
            currentY += 25;
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line, 50, currentY);
    
    if (wrongAnswers.length > 0) {
        currentY += 50;
        ctx.fillStyle = '#F44336';
        ctx.font = 'bold 20px Arial';
        ctx.fillText(`错题分析 Wrong Answers (${wrongAnswers.length} 题)`, 50, currentY);
        
        ctx.fillStyle = '#333';
        ctx.font = '16px Arial';
        
        wrongAnswers.forEach((error, index) => {
            currentY += 30;
            ctx.fillText(`${index + 1}. 第${error.number}题: ${error.selected} → ${error.correct}`, 50, currentY);
        });
    }
    
    ctx.fillStyle = '#666';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('继续加油，学好马来西亚历史！Keep studying Malaysian History!', canvas.width/2, canvas.height - 30);
    
    const reportDiv = document.getElementById('reportCanvas');
    reportDiv.innerHTML = `
        <div class="canvas-container">
            <h3>📋 成绩单已生成</h3>
            <canvas id="generatedCanvas" width="800" height="${canvas.height}" style="max-width: 100%; height: auto; border: 1px solid #ddd;"></canvas>
            <div style="margin-top: 15px;">
                <button class="download-btn" onclick="downloadReportImage()">💾 下载图片</button>
                <button class="save-btn" onclick="shareReportImage()">📤 分享图片</button>
            </div>
            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                💡 提示：点击"下载图片"保存到设备，或点击"分享图片"通过其他应用分享
            </p>
        </div>
    `;
    
    const displayCanvas = document.getElementById('generatedCanvas');
    displayCanvas.height = canvas.height;
    const displayCtx = displayCanvas.getContext('2d');
    displayCtx.drawImage(canvas, 0, 0);
    
    window.reportCanvas = canvas;
    reportDiv.scrollIntoView({ behavior: 'smooth' });
}

function downloadReportImage() {
    if (window.reportCanvas) {
        const today = new Date();
        const dateStr = formatDate(today).replace(/\//g, '-');
        const link = document.createElement('a');
        link.download = `F5_SEJ_BAB1.1_成绩单_${dateStr}.png`;
        link.href = window.reportCanvas.toDataURL();
        link.click();
    }
}

function shareReportImage() {
    if (navigator.share && window.reportCanvas) {
        window.reportCanvas.toBlob(function(blob) {
            const file = new File([blob], 'F5_SEJ_BAB1.1_成绩单.png', { type: 'image/png' });
            navigator.share({
                title: 'F5 SEJ BAB 1.1 Quiz 成绩单',
                text: '我的F5历史Bab 1.1国家主权测验成绩单',
                files: [file]
            }).catch(err => {
                console.log('分享失败:', err);
                downloadReportImage();
            });
        });
    } else {
        downloadReportImage();
        alert('成绩单图片已下载到您的设备 📱');
    }
}

function saveAttempt(name, form, score, results) {
    const attempts = JSON.parse(localStorage.getItem('f5sej11QuizAttempts') || '[]');
    const attempt = {
        date: new Date().toLocaleString(),
        name,
        form,
        score,
        results
    };
    
    attempts.unshift(attempt);
    localStorage.setItem('f5sej11QuizAttempts', JSON.stringify(attempts));
}

function loadHistory() {
    const attempts = JSON.parse(localStorage.getItem('f5sej11QuizAttempts') || '[]');
    const historyList = document.getElementById('historyList');
    
    if (attempts.length === 0) {
        historyList.innerHTML = "<p>你还没有任何测验记录，快去做测验吧！</p>";
        return;
    }
    
    let html = "";
    attempts.forEach((attempt, index) => {
        html += `
            <div class="question" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px;">
                <h3>测验 #${index + 1} - ${attempt.date}</h3>
                <p>姓名: ${attempt.name} | 年级: ${attempt.form}</p>
                <p>得分: <strong>${attempt.score} / 10</strong></p>
                <button onclick="viewAttemptDetails(${index})">查看详情</button>
                <div style="margin-top: 10px;">
                    <button class="download-btn" onclick="generateHistoryReportImage(${index})" style="font-size: 12px; padding: 8px 12px;">🖼️ 生成成绩单图片</button>
                </div>
                <div id="attemptDetails${index}" style="display: none; margin-top: 10px;">
                    ${attempt.results.map((r, qIndex) => `
                        <div style="margin-bottom: 15px; padding: 10px; background: ${r.isCorrect ? '#e6ffe6' : '#ffe6e6'}; border-radius: 5px;">
                            <p><strong>第${qIndex + 1}题：${r.isCorrect ? '正确 ✅' : '错误 ❌'}</strong></p>
                            <p>题目: ${r.question}</p>
                            ${!r.isCorrect ? `<p>你的答案: ${r.selected}</p>` : ''}
                            <p>正确答案: ${r.correct}</p>
                            <p>解释: ${r.explain}</p>
                            <p>鼓励: ${r.encourage}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    historyList.innerHTML = html;
}

function generateHistoryReportImage(attemptIndex) {
    const attempts = JSON.parse(localStorage.getItem('f5sej11QuizAttempts') || '[]');
    const attempt = attempts[attemptIndex];
    
    if (!attempt) {
        alert("找不到该测验记录！");
        return;
    }
    
    const unanswered = attempt.results.filter(r => r.selected === "未作答").length;
    const wrongAnswers = attempt.results.filter(r => !r.isCorrect).map((r, index) => ({
        number: attempt.results.indexOf(r) + 1,
        question: r.question.substring(0, 50) + "...",
        selected: r.selected,
        correct: r.correct
    }));

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    const baseHeight = 800;
    const errorHeight = wrongAnswers.length * 30 + 100;
    canvas.width = 800;
    canvas.height = Math.max(baseHeight, baseHeight + errorHeight);
    
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#f8f9fa');
    gradient.addColorStop(1, '#e9ecef');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = '#2c3e50';
    ctx.fillRect(0, 0, canvas.width, 120);
    
    ctx.fillStyle = 'white';
    ctx.font = 'bold 28px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('F5 SEJ BAB 1.1 Quiz', canvas.width/2, 45);
    ctx.font = 'bold 24px Arial';
    ctx.fillText('Kedaulatan Negara', canvas.width/2, 75);
    ctx.font = '18px Arial';
    ctx.fillText('国家主权测验成绩单', canvas.width/2, 100);
    
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('学生信息 Student Information', 50, 170);
    
    let formattedDate;
    try {
        const attemptDate = new Date(attempt.date);
        formattedDate = formatDate(attemptDate);
    } catch (error) {
        formattedDate = attempt.date;
    }
    
    ctx.font = '20px Arial';
    ctx.fillText(`姓名 Name: ${attempt.name}`, 50, 210);
    ctx.fillText(`年级 Form: ${attempt.form}`, 50, 240);
    ctx.fillText(`测验日期 Date: ${formattedDate}`, 50, 270);
    
    const percentage = Math.round((attempt.score / 10) * 100);
    
    ctx.fillStyle = '#2196F3';
    ctx.font = 'bold 24px Arial';
    ctx.fillText('测验成绩 Test Results', 50, 320);
    
    const centerX = canvas.width - 150;
    const centerY = 370;
    const radius = 80;
    
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fillStyle = attempt.score >= 8 ? '#4CAF50' : attempt.score >= 5 ? '#FF9800' : '#F44336';
    ctx.fill();
    
    ctx.fillStyle = 'white';
    ctx.font = 'bold 36px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${attempt.score}/10`, centerX, centerY - 10);
    ctx.font = 'bold 20px Arial';
    ctx.fillText(`${percentage}%`, centerX, centerY + 20);
    
    ctx.fillStyle = '#333';
    ctx.font = '20px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`总分 Total Score: ${attempt.score}/10 (${percentage}%)`, 50, 360);
    
    if (unanswered > 0) {
        ctx.fillStyle = '#F44336';
        ctx.fillText(`未作答题目 Unanswered: ${unanswered} 题`, 50, 390);
    }
    
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    let currentY = unanswered > 0 ? 450 : 420;
    ctx.fillText('表现分析 Performance Analysis', 50, currentY);
    
    ctx.font = '18px Arial';
    const feedback = getFeedback(attempt.score);
    const words = feedback.split(' ');
    let line = '';
    currentY += 30;
    
    for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        if (testWidth > 700 && n > 0) {
            ctx.fillText(line, 50, currentY);
            line = words[n] + ' ';
            currentY += 25;
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line, 50, currentY);
    
    if (wrongAnswers.length > 0) {
        currentY += 50;
        ctx.fillStyle = '#F44336';
        ctx.font = 'bold 20px Arial';
        ctx.fillText(`错题分析 Wrong Answers (${wrongAnswers.length} 题)`, 50, currentY);
        
        ctx.fillStyle = '#333';
        ctx.font = '16px Arial';
        
        wrongAnswers.forEach((error, index) => {
            currentY += 30;
            ctx.fillText(`${index + 1}. 第${error.number}题: ${error.selected} → ${error.correct}`, 50, currentY);
        });
    }
    
    ctx.fillStyle = '#666';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('继续加油，学好马来西亚历史！Keep studying Malaysian History!', canvas.width/2, canvas.height - 30);
    
    let downloadDateStr;
    try {
        const attemptDate = new Date(attempt.date);
        downloadDateStr = formatDate(attemptDate).replace(/\//g, '-');
    } catch (error) {
        downloadDateStr = attempt.date.replace(/[/:]/g, '-');
    }
    
    const link = document.createElement('a');
    link.download = `F5_SEJ_BAB1.1_成绩单_${attempt.name}_${downloadDateStr}.png`;
    link.href = canvas.toDataURL();
    link.click();
    
    alert('成绩单图片已下载！您可以保存或通过其他方式分享 📱');
}

function viewAttemptDetails(index) {
    const detailsDiv = document.getElementById(`attemptDetails${index}`);
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
    } else {
        detailsDiv.style.display = 'none';
    }
}

function saveProgress() {
    const name = document.getElementById('name').value;
    const form = document.getElementById('form').value;
    
    if (!name || !form) {
        alert("请先填写个人信息！");
        return;
    }
    
    const progress = {
        name,
        form,
        answers: []
    };
    
    questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        progress.answers.push(selected ? selected.value : null);
    });
    
    localStorage.setItem('f5sej11QuizProgress', JSON.stringify(progress));
    alert("进度已保存！你可以稍后回来继续完成测验。");
}

function loadProgress() {
    const progress = JSON.parse(localStorage.getItem('f5sej11QuizProgress'));
    
    if (!progress) {
        alert("没有找到保存的进度！");
        return;
    }
    
    document.getElementById('name').value = progress.name;
    document.getElementById('form').value = progress.form;
    
    progress.answers.forEach((answer, index) => {
        if (answer) {
            const radio = document.querySelector(`input[name="q${index}"][value="${answer}"]`);
            if (radio) {
                radio.checked = true;
                const label = radio.closest('label');
                if (label) {
                    label.classList.add('selected');
                }
            }
        }
    });
    
    alert("进度已加载！你可以继续完成测验。");
}

window.onload = function() {
    const qDiv = document.getElementById('questions');
    questions.forEach((q, index) => {
        const div = document.createElement('div');
        div.className = "question";
        div.innerHTML = `<p><strong>第${index + 1}题.</strong> ${q.q}</p>` +
                        q.options.map((opt, optIndex) => `
                            <label onclick="selectOption(this, ${index}, ${optIndex})">
                                <input type="radio" name="q${index}" value="${opt}">
                                <span>${opt}</span>
                            </label>
                        `).join('');
        qDiv.appendChild(div);
        
        div.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    const questionDiv = this.closest('.question');
                    const allLabels = questionDiv.querySelectorAll('label');
                    allLabels.forEach(label => label.classList.remove('selected'));
                    
                    const currentLabel = this.closest('label');
                    if (currentLabel) {
                        currentLabel.classList.add('selected');
                    }
                }
            });
        });
    });
    
    if (localStorage.getItem('f5sej11QuizProgress')) {
        if (confirm("检测到有保存的进度，是否加载？")) {
            loadProgress();
        }
    }
}

function selectOption(labelElement, questionIndex, optionIndex) {
    const questionDiv = labelElement.closest('.question');
    const allLabels = questionDiv.querySelectorAll('label');
    allLabels.forEach(label => label.classList.remove('selected'));
    
    labelElement.classList.add('selected');
    
    const radioButton = labelElement.querySelector('input[type="radio"]');
    radioButton.checked = true;
    
    radioButton.value = questions[questionIndex].options[optionIndex];
}
</script>

</body>
</html>